#!/usr/bin/env bash

set -e

DIR="$(cd "$(dirname "$0")/.." && pwd)" && cd "$DIR"
TMPDIR=$(mktemp -d)
REMOTE_URL=$(git config --get-regexp '^remote.*url' | awk '{print $2}' | tail -n 1)

trap 'rm -rf -- "$TMPDIR"' EXIT

if ! grep -q 'nothing to commit, working tree cleannothing to commit' <(git status public); then
  git add public
  git commit -m "Update static files in public"
  git push origin main
fi

# delete gh-pages remotely
#grep -qE "remotes/.*/gh-pages" <(git branch -a) && git push -d $GIT_REMOTE gh-pages

# delete gh-pages locally
#grep -q 'gh-pages' <(git branch -a) && git branch -d gh-pages

if [[ -d public ]]; then
  LS_FILES=$(git ls-files public | sed "s,^,$DIR/,g")
  cd $TMPDIR
  git clone -b gh-pages $REMOTE_URL && cd "$(basename "$_" .git)"

  find . -mindepth 1 -type f ! -path "*.git*" -print -exec mv {} ../ \;
  cp $LS_FILES .

  git add .
  git commit -m "Republish gh-pages"
  git push origin gh-pages
fi
